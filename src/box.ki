import stdlib;

defclass[T] move box *T;

access box[_] {
  inline func[T] do_init(u *box[T]) void {
    u->~ = @[*T]cast(checkmalloc(sizeof@[T]));
    init(u->~);
  }

  inline func[T] do_copy(dest *box[T], src *box[T]) void {
    dest->~ = @[*T]cast(checkmalloc(sizeof@[T]));
    copy(dest->~, src->~);
  }

  inline func[T] do_destroy(u *box[T]) void {
    destroy(u->~);
    free(@[*void]cast(u->~));
  }

  inline func[T] oo(x *box[T]) *T {
    return x->~;
  }
}

inline func[T] embox(val T) box[T] {
  ret box[T];
  *oo(&ret) = val;
  return ret;
}
